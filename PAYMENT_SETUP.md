# 토스페이먼츠 결제 시스템 설정 가이드

## 개요

토스페이먼츠를 활용한 크레딧 충전 시스템을 설정하는 방법입니다.

## 1. 토스페이먼츠 계정 설정

1. [토스페이먼츠 개발자센터](https://developers.tosspayments.com/)에 접속
2. 계정 생성 및 로그인
3. 테스트/운영 환경 선택
4. API 키 발급
   - 시크릿 키 (Secret Key): 서버 사이드에서 사용
   - 클라이언트 키 (Client Key): 프론트엔드에서 사용 (현재는 사용하지 않음)

## 2. 환경 변수 설정

`.env` 파일에 다음 환경 변수를 추가하세요:

```env
# 토스페이먼츠 API 키
TOSS_PAYMENTS_SECRET_KEY=test_sk_xxxxxxxxxxxxx

# 5천원당 제공할 크레딧 수 (기본값: 10000)
CREDITS_PER_5000_WON=10000

# 애플리케이션 URL (결제 성공/실패 리다이렉트용)
PUBLIC_APP_URL=http://localhost:5173
```

### 환경 변수 설명

- `TOSS_PAYMENTS_SECRET_KEY`: 토스페이먼츠에서 발급받은 시크릿 키
  - 테스트 환경: `test_sk_`로 시작
  - 운영 환경: `live_sk_`로 시작
- `CREDITS_PER_5000_WON`: 5천원 결제 시 제공할 크레딧 수
  - 기본값: 10,000 크레딧
  - 계산식: `(결제금액 / 5000) * CREDITS_PER_5000_WON`
- `PUBLIC_APP_URL`: 결제 완료 후 리다이렉트될 URL
  - 개발 환경: `http://localhost:5173`
  - 운영 환경: 실제 도메인 URL

## 3. 데이터베이스 마이그레이션

Supabase SQL Editor에서 다음 SQL을 실행하세요:

```sql
-- create_payment_tables.sql 파일의 내용 실행
```

또는 프로젝트 루트의 `create_payment_tables.sql` 파일을 Supabase SQL Editor에서 실행하세요.

## 4. 크레딧 시스템 설명

### 크레딧 차감 방식

- **사용자 메시지**: 메시지 1개당 0.5 크레딧 차감
- **AI 응답**: 토큰 수에 따라 차감
  - 입력 토큰: 약 0.3 크레딧
  - 출력 토큰: 약 0.7 크레딧
  - 평균 1회 주고받음: 약 1.5 크레딧

### 크레딧 계산 예시

- 5,000원 결제 → 10,000 크레딧
- 약 6,666회 주고받음 가능 (10,000 / 1.5)

## 5. 결제 플로우

1. 사용자가 결제 페이지(`/payments`)에서 금액 선택
2. 결제 버튼 클릭 → `/api/payments/create` 호출
3. 토스페이먼츠 결제 페이지로 리다이렉트
4. 결제 완료 → `/payments/success` 페이지로 리다이렉트
5. `/api/payments/confirm` 호출하여 결제 승인
6. 크레딧 자동 추가

## 6. 웹훅 설정 (선택사항)

토스페이먼츠 대시보드에서 웹훅 URL을 설정할 수 있습니다:

```
https://your-domain.com/api/payments/webhook
```

웹훅을 설정하면 결제 완료 시 자동으로 크레딧이 추가됩니다.

## 7. 테스트

### 샌드박스 테스트 카드

토스페이먼츠 샌드박스 환경에서 다음 테스트 카드를 사용할 수 있습니다:

- **성공**: 1234-1234-1234-1234
- **실패**: 4000-0000-0000-0002
- **한도 초과**: 4000-0000-0000-9999

유효기간: 미래 날짜
CVC: 임의의 3자리 숫자
비밀번호: 12자리 숫자

## 8. 문제 해결

### 크레딧이 추가되지 않는 경우

1. 결제 상태 확인: `payments` 테이블에서 `status` 확인
2. 웹훅 로그 확인: 서버 로그에서 웹훅 수신 여부 확인
3. 수동 처리: 필요시 관리자 페이지에서 수동으로 크레딧 추가

### 결제 승인 실패

1. 토스페이먼츠 대시보드에서 결제 내역 확인
2. API 키가 올바른지 확인
3. 네트워크 연결 확인

## 참고 자료

- [토스페이먼츠 API 레퍼런스](https://docs.tosspayments.com/reference)
- [토스페이먼츠 시작 가이드](https://docs.tosspayments.com/guides/v2/get-started/llms-guide)



